# 📘 Exchange APIライブラリ 親仕様書（詳細版）

唯一の親仕様書。7層構造と実装方針を詳細化し、開発・テスト・運用の全工程で参照する基準とする。

---

## 1. 目的
複数の暗号資産取引所が提供するREST APIを、**単一の統一インターフェース**で利用できる抽象化ライブラリとして構築する。

### 背景
- 取引所ごとにAPI仕様（エンドポイント、署名、パラメータ、レスポンス形式）が異なり、同一機能でも実装やエラーハンドリングがばらつく。
- 取引所固有の実装は再利用が難しく、取引所追加やAPI変更時に大規模な改修が必要となる。
- 金融取引では高信頼性・一貫性・エラー復旧性が求められ、単純なAPIラッパーでは要件を満たしにくい。

### 目標
- 取引所間の差異をAdapter層に隔離し、上位層からは統一I/Fで利用可能にする。
- 発注、照会、キャンセル、残高取得等の主要機能を共通仕様化。
- API呼び出し結果は`Result<T>`で返却し、成功・失敗・エラー理由を明確化。
- 高い保守性・拡張性・テスト容易性を持つ構造にする。

### 設計思想
- **DDD準拠**：ドメインモデル主体でユースケースを表現。
- **責務分離**：各層が単一責務を持ち、依存方向は下位のみ。
- **拡張容易性**：新規取引所追加時はAdapter実装を追加するだけで完結。
- **テスト性**：モック注入可能なI/F設計、層単位テスト可能。
- **可観測性**：構造化ログとメトリクス出力による稼働状況の可視化。

---

## 2. アーキテクチャ（7層）
依存方向は下位層のみとし、層ごとに明確な責務を定義する。

```
[ UI / API ]         : 外部公開I/F、アプリや外部サービスから利用
    ↓
[ Application ]      : ユースケース制御、Mapper、Result生成
    ↓
[ Domain.Model / Dto ] : エンティティ、値オブジェクト、DTO定義
    ↓
[ Adapter.XYZ ]      : 取引所固有のAPI実装、レスポンス変換
    ↓
[ Protocol ]         : 署名、認証ヘッダ生成、時刻同期
    ↓
[ Rest.Extension ]   : ログ、リトライ、JSON共通処理
    ↓
[ Rest.Core ]        : HTTPクライアント基盤、低レベル通信
```

---

## 3. モジュール構成詳細
### Application
- **責務**：ユースケース定義、DTO⇔Domain変換、結果返却。
- **主要コンポーネント**：
  - UseCaseインターフェース（例：`IPlaceMarketOrderUseCase`）
  - Mapper
  - Resultユーティリティ

### Domain
- **責務**：取引所に依存しないビジネスロジック。
- **主要コンポーネント**：
  - Entity（Order, Symbol, Balance）
  - Value Object（Price, Quantity, Money）
  - DTO（発注依頼・応答、残高情報）

### Adapter
- **責務**：取引所固有のAPI呼び出し実装。
- **主要コンポーネント**：
  - エンドポイント呼び出し
  - JSONレスポンス解析
  - 共通DTOへの変換

### Protocol
- **責務**：APIキー署名、認証ヘッダ生成、サーバ時刻同期。
- **主要コンポーネント**：
  - HMAC署名生成
  - 時刻ドリフト補正（許容±秒設定）

### Rest.Core
- **責務**：HTTP通信の基盤。
- **主要コンポーネント**：
  - GET/POST実装（タイムアウト、キャンセル対応）
  - エラー種別（ネットワーク、タイムアウト、不正応答）

### Rest.Extension
- **責務**：HTTP通信の拡張処理。
- **主要コンポーネント**：
  - ログ出力（構造化）
  - リトライポリシー（指数バックオフ+ジッタ）
  - JSONシリアライズ/デシリアライズ

---

## 4. 共通処理配置詳細
- **HTTP通信**：Rest.Coreに集約、I/F統一。
- **ログ/リトライ/JSON**：Rest.Extensionで共通実装。
- **DTO変換**：Domain.Dto + Mapperで統一。
- **署名/ヘッダ生成**：Protocolに集約。
- **抽象契約**：Abstractで全取引所共通I/Fを定義。

---

## 5. 実装ステップ詳細
1. **αフェーズ**（最小動作）
   - Rest.Core + Domain + Application
   - Done：`PlaceMarketOrder`が`Result<T>`で返る
2. **βフェーズ**（取引所疎通）
   - Adapter + Protocol
   - 実取引所での発注・照会・残高確認
3. **γフェーズ**（拡張）
   - Rest.Extension（ログ、リトライ、JSON）
4. **RCフェーズ**（リリース候補）
   - ドキュメント整備、全テスト通過、CI/CD統合

---

## 6. Done Criteria詳細
- **機能**：
  - `PlaceMarketOrder`が`Result<T>`で返る
  - 主要操作（発注・照会・キャンセル・残高取得）の共通I/F化
- **品質**：
  - 全テスト通過（単体・結合・E2E）
  - カバレッジ目安：80%以上
- **運用**：
  - CI/CDパイプラインに組み込み済み
  - 構造化ログ・メトリクス出力確認済み
